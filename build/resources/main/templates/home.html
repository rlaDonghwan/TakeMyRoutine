<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<div th:include="navigation.html"></div>
<div class="container">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h3 class="text-center mb-4">Todo List</h3>
            <div class="border p-3">
                <button class="btn btn-success mb-3"
                        th:onclick="|location.href='@{/{loginType}/todoInsert (loginType=${loginType})}'|">추가
                </button>
                <button class="btn btn-primary mb-3" onclick="openUpdateModal()">수정</button>

                <!-- 완료 버튼에 onclick 이벤트 추가 -->
                <button class="btn btn-danger mb-3" onclick="completeTodo()">완료</button>

                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>Select</th>
                        <th>Title</th>
                        <th>Memo</th>
                        <th>Place</th>
                        <th>Date and Time</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="todo : ${todoList}">
                        <td>
                            <input type="checkbox" class="select-checkbox" th:value="${todo.id}"/>
                        </td>
                        <td th:text="${todo.title}"></td>
                        <td th:text="${todo.memo}"></td>
                        <td th:text="${todo.place}"></td>
                        <td th:text="${todo.dataTime}"></td>

                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- 모달 창 -->
<div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateModalLabel">Todo 수정</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- 수정 폼 -->
                <form>
                    <div class="form-group">
                        <label for="updateTitle">제목</label>
                        <input type="text" class="form-control" id="updateTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="updateMemo">메모</label>
                        <textarea class="form-control" id="updateMemo" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="updatePlace">장소</label>
                        <input type="text" class="form-control" id="updatePlace" required>
                    </div>
                    <div class="form-group">
                        <label for="updateDateTime">날짜 및 시간</label>
                        <input type="datetime-local" class="form-control" id="updateDateTime" required>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="updateTodo()">저장</button>
                </form>
            </div>
        </div>
    </div>
</div>
</body>
<script>
    function updateButtonState() {
        var selectedIds = document.querySelectorAll('.select-checkbox:checked');
        var updateButton = document.querySelector('.btn-primary');

        if (selectedIds.length === 1) {
            updateButton.disabled = false;
            selectedTodoId = selectedIds[0].value;
        } else {
            updateButton.disabled = true;
        }
    }
    function completeTodo() {
        var selectedIds = document.querySelectorAll('.select-checkbox:checked');

        if (selectedIds.length === 0) {
            alert('선택된 항목이 없습니다.');
        } else {
            if (confirm('선택된 항목을 완료하시겠습니까?')) {
                var todoIds = Array.from(selectedIds).map(function (checkbox) {
                    return checkbox.value;
                });

                $.ajax({
                    type: 'POST',
                    url: '/home/deleteTodos',
                    contentType: 'application/json',
                    data: JSON.stringify({todoIds: todoIds}),
                    success: function (response) {
                        console.log(response);
                        location.reload();
                    },
                    error: function (error) {
                        console.log(error.responseText);
                        alert('서버 오류가 발생했습니다.');
                    }
                });
            }
        }
    }

    var selectedTodoId;

    function openUpdateModal() {
        updateButtonState();  // 모달 열기 전에 상태 업데이트

        if (selectedTodoId) {
            // 모달 열기
            $('#updateModal').modal('show');

            // 모달 내용 초기화 (예시: Todo의 값으로 초기화)
            var selectedTodo = findTodoById(selectedTodoId);  // Todo를 실제 데이터에서 찾는 함수 사용
            document.getElementById('updateTitle').value = selectedTodo.title;
            document.getElementById('updateMemo').value = selectedTodo.memo;
            document.getElementById('updatePlace').value = selectedTodo.place;

            // 시간 값 초기화
            var dateTime = selectedTodo.dateTime.split('T');
            var date = dateTime[0];
            var time = dateTime[1];
            document.getElementById('updateDateTime').value = date + 'T' + time;
        } else {
            alert('수정할 항목을 선택해주세요.');
        }
    }


    function updateTodo() {
        var updatedTitle = document.getElementById('updateTitle').value;
        var updatedMemo = document.getElementById('updateMemo').value;
        var updatedPlace = document.getElementById('updatePlace').value;

        // 시간 값 가져오기
        var updatedDateTime = document.getElementById('updateDateTime').value;

        // 입력값이 비어있는지 확인
        if (!updatedTitle || !updatedMemo || !updatedPlace || !updatedDateTime) {
            alert('모든 값을 입력하세요.');
            return;
        }

        // 서버로 수정된 Todo 전송 (Ajax 또는 폼 제출 방식으로)
        $.ajax({
            type: 'POST',
            url: '/home/updateTodo',
            contentType: 'application/json',
            data: JSON.stringify({
                todoId: selectedTodoId,
                updatedTitle: updatedTitle,
                updatedMemo: updatedMemo,
                updatedPlace: updatedPlace,
                updatedDateTime: updatedDateTime  // 시간 값을 전송
            }),
            success: function (response) {
                console.log(response);
                location.reload();
            },
            error: function (error) {
                console.log(error.responseText);
                alert('서버 오류가 발생했습니다.');
            }
        });

        // 모달 닫기
        $('#updateModal').modal('hide');
    }


</script>


</html>
